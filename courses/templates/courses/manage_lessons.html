{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Управление уроками" %} - {{ course.title }}{% endblock %}

{% block content %}
<div class="container mt-5" data-aos="fade-up">
    <h1>{% trans "Управление уроками" %} {{ course.title }}</h1>
    {% include 'partials/messages.html' %}

    <h3>{% trans "Добавить новый урок" %}</h3>
    <form method="post" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        {{ lesson_form.as_p }}
        <button type="submit" class="btn btn-primary">{% trans "Добавить урок" %}</button>
    </form>

    <h3 class="mt-5">{% trans "Уроки" %}</h3>
    {% if lessons_with_tests %}
    <div class="list-group" id="lesson-list">
        {% for item in lessons_with_tests %}
        <div class="list-group-item" data-id="{{ item.lesson.id }}" data-aos="fade-up">
            <h5>{{ item.lesson.title }} {% if item.lesson.is_published %}
                <span class="badge bg-success">{% trans "Опубликовать" %}</span>
                {% else %}
                <span class="badge bg-warning">{% trans "Выбрать" %}</span>
                {% endif %}
            </h5>
            <p>{{ item.lesson.description|truncatewords:20 }}</p>
            <!-- Тесты для урока -->
            {% if item.tests %}
            <h6>{% trans "Тесты" %}:</h6>
            <ul>
                {% for test in item.tests %}
                <li>
                    {{ test.title }} (Вопросы: {{ test.questions.count }}, Опубликован: {{ test.is_active|yesno:"ДА,НЕТ" }})
                    <a href="{% url 'courses:manage_test_questions' test_id=test.id %}" class="btn btn-sm btn-outline-primary">{% trans "Управление вопросами" %}</a>
                    <a href="{% url 'courses:manage_test_results' test_id=test.id %}" class="btn btn-sm btn-outline-danger">{% trans "Управление результатами" %}</a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>{% trans "Для этого урока нет тестов." %}</p>
            {% endif %}
            <a href="{% url 'courses:lesson_edit' pk=item.lesson.id %}" class="btn btn-sm btn-warning">{% trans "Редактировать" %}</a>
            <a href="{% url 'courses:lesson_detail' lesson_id=item.lesson.id %}" class="btn btn-sm btn-info">{% trans "Просмотр" %}</a>
            <a href="{% url 'courses:lesson_preview' lesson_id=item.lesson.id %}" class="btn btn-sm btn-outline-info">{% trans "Обложка" %}</a>
            <a href="{% url 'courses:create_test' lesson_id=item.lesson.id %}" class="btn btn-sm btn-secondary">{% trans "Добавить тест" %}</a>
        </div>
        {% endfor %}
    </div>
    <button class="btn btn-primary mt-3" onclick="saveOrder()">{% trans "Сохранить" %}</button>
    {% else %}
    <div class="alert alert-info" data-aos="fade-up">
        {% trans "В этом курсе нет уроков." %}
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var lessonList = document.getElementById('lesson-list');
        if (lessonList) {
            new Sortable(lessonList, {
                animation: 150,
                handle: '.list-group-item',
                onEnd: function(evt) {
                    console.log('Lesson order changed');
                }
            });

            document.querySelectorAll('#lesson-list .list-group-item').forEach(function(item, index) {
                item.setAttribute('data-aos-delay', index * 100);
            });
        }

        AOS.init();
    });

    function saveOrder() {
        var order = [];
        document.querySelectorAll('#lesson-list .list-group-item').forEach(function(item) {
            order.push(item.getAttribute('data-id'));
        });
        fetch("{% url 'courses:reorder_lessons' course.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'order[]=' + order.join('&order[]=')
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('{% trans "Lesson order saved!" %}');
            } else {
                alert('{% trans "Error saving order." %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error saving order." %}');
        });
    }
</script>
{% endblock %}